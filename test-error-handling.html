<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Handling Test - ì‚¬ë‹¤ë¦¬íƒ€ê¸° ê²Œì„</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8f9fa;
        }
        .test-section {
            background: white;
            padding: 2rem;
            margin: 1rem 0;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 0.5rem;
            font-weight: 600;
            transition: transform 0.2s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
        }
        .test-results {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .error-test-container {
            min-height: 200px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Error Handling Test Suite</h1>
    <p>ì‚¬ë‹¤ë¦¬íƒ€ê¸° ê²Œì„ì˜ ì˜¤ë¥˜ ì²˜ë¦¬ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>

    <div class="test-section">
        <h2>1. ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ê²€ì‚¬</h2>
        <button class="test-button" onclick="testBrowserSupport()">ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸</button>
        <div id="browserSupportResults" class="test-results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>2. ì…ë ¥ ê²€ì¦ í…ŒìŠ¤íŠ¸</h2>
        <button class="test-button" onclick="testSlotCountValidation()">ìŠ¬ë¡¯ ìˆ˜ ê²€ì¦</button>
        <button class="test-button" onclick="testSlotContentValidation()">ìŠ¬ë¡¯ ë‚´ìš© ê²€ì¦</button>
        <div id="validationResults" class="test-results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>3. ì €ì¥ì†Œ ì˜¤ë¥˜ ì²˜ë¦¬</h2>
        <button class="test-button" onclick="testStorageErrors()">ì €ì¥ì†Œ ì˜¤ë¥˜ ì‹œë®¬ë ˆì´ì…˜</button>
        <button class="test-button" onclick="testQuotaExceeded()">ì €ì¥ ê³µê°„ ë¶€ì¡± ì‹œë®¬ë ˆì´ì…˜</button>
        <div id="storageResults" class="test-results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>4. Canvas ëŒ€ì²´ ê¸°ëŠ¥</h2>
        <button class="test-button" onclick="testCanvasFallback()">Canvas ëŒ€ì²´ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</button>
        <div class="error-test-container" id="canvasFallbackContainer"></div>
    </div>

    <div class="test-section">
        <h2>5. ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ</h2>
        <button class="test-button" onclick="testErrorMessages()">ì˜¤ë¥˜ ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸</button>
        <div class="error-test-container" id="errorMessageContainer"></div>
    </div>

    <!-- Include the error handler and related scripts -->
    <script src="js/error-handler.js"></script>
    <script src="js/storage.js"></script>

    <script>
        let errorHandler;
        let storageManager;

        // Initialize components
        document.addEventListener('DOMContentLoaded', () => {
            errorHandler = new ErrorHandler();
            storageManager = new StorageManager();
            console.log('Test suite initialized');
        });

        function testBrowserSupport() {
            const resultsDiv = document.getElementById('browserSupportResults');
            resultsDiv.style.display = 'block';
            
            if (!errorHandler) {
                resultsDiv.innerHTML = '<p style="color: red;">âŒ ErrorHandler not initialized</p>';
                return;
            }

            const support = errorHandler.browserSupport;
            let html = '<h3>ë¸Œë¼ìš°ì € ì§€ì› í˜„í™©:</h3><ul>';
            
            Object.entries(support).forEach(([feature, supported]) => {
                const icon = supported ? 'âœ…' : 'âŒ';
                const status = supported ? 'ì§€ì›ë¨' : 'ì§€ì›ë˜ì§€ ì•ŠìŒ';
                html += `<li>${icon} <strong>${feature}:</strong> ${status}</li>`;
            });
            
            html += '</ul>';
            
            // Add recommendations
            const unsupportedFeatures = Object.entries(support)
                .filter(([feature, supported]) => !supported)
                .map(([feature]) => feature);
            
            if (unsupportedFeatures.length > 0) {
                html += '<h4>ê¶Œì¥ì‚¬í•­:</h4><ul>';
                unsupportedFeatures.forEach(feature => {
                    switch (feature) {
                        case 'localStorage':
                            html += '<li>ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¿ í‚¤/ì €ì¥ì†Œë¥¼ í—ˆìš©í•˜ê±°ë‚˜ ì‹œí¬ë¦¿ ëª¨ë“œë¥¼ í•´ì œí•˜ì„¸ìš”</li>';
                            break;
                        case 'canvas':
                            html += '<li>ìµœì‹  ë¸Œë¼ìš°ì €ë¡œ ì—…ë°ì´íŠ¸í•˜ì—¬ Canvas ì§€ì›ì„ ë°›ìœ¼ì„¸ìš”</li>';
                            break;
                        case 'es6':
                            html += '<li>ìµœì‹  ë¸Œë¼ìš°ì €ë¡œ ì—…ë°ì´íŠ¸í•˜ì—¬ ES6 ì§€ì›ì„ ë°›ìœ¼ì„¸ìš”</li>';
                            break;
                    }
                });
                html += '</ul>';
            }
            
            resultsDiv.innerHTML = html;
        }

        function testSlotCountValidation() {
            const resultsDiv = document.getElementById('validationResults');
            resultsDiv.style.display = 'block';
            
            if (!errorHandler) {
                resultsDiv.innerHTML = '<p style="color: red;">âŒ ErrorHandler not initialized</p>';
                return;
            }

            const testCases = [
                { input: '', expected: false, description: 'ë¹ˆ ê°’' },
                { input: 'abc', expected: false, description: 'ë¬¸ìì—´' },
                { input: '1', expected: false, description: 'ìµœì†Œê°’ ë¯¸ë§Œ (1)' },
                { input: '2', expected: true, description: 'ìµœì†Œê°’ (2)' },
                { input: '10', expected: true, description: 'ì •ìƒê°’ (10)' },
                { input: '16', expected: true, description: 'ê²½ê³ ê°’ (16)' },
                { input: '20', expected: true, description: 'ìµœëŒ€ê°’ (20)' },
                { input: '21', expected: false, description: 'ìµœëŒ€ê°’ ì´ˆê³¼ (21)' },
                { input: '-5', expected: false, description: 'ìŒìˆ˜' },
                { input: '3.5', expected: true, description: 'ì†Œìˆ˜ì  (3.5 â†’ 3)' }
            ];

            let html = '<h3>ìŠ¬ë¡¯ ìˆ˜ ê²€ì¦ í…ŒìŠ¤íŠ¸:</h3><table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #f0f0f0;"><th style="padding: 8px; border: 1px solid #ddd;">ì…ë ¥ê°’</th><th style="padding: 8px; border: 1px solid #ddd;">ì„¤ëª…</th><th style="padding: 8px; border: 1px solid #ddd;">ì˜ˆìƒ</th><th style="padding: 8px; border: 1px solid #ddd;">ê²°ê³¼</th><th style="padding: 8px; border: 1px solid #ddd;">ë©”ì‹œì§€</th></tr>';

            testCases.forEach(testCase => {
                const validation = errorHandler.validateSlotCount(testCase.input);
                const passed = validation.isValid === testCase.expected;
                const icon = passed ? 'âœ…' : 'âŒ';
                const errorMessages = validation.errors.map(e => e.message).join(', ');
                
                html += `<tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${testCase.input}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${testCase.description}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${testCase.expected ? 'ìœ íš¨' : 'ë¬´íš¨'}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${icon} ${validation.isValid ? 'ìœ íš¨' : 'ë¬´íš¨'}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; font-size: 0.9em;">${errorMessages}</td>
                </tr>`;
            });

            html += '</table>';
            resultsDiv.innerHTML = html;
        }

        function testSlotContentValidation() {
            const resultsDiv = document.getElementById('validationResults');
            resultsDiv.style.display = 'block';
            
            if (!errorHandler) {
                resultsDiv.innerHTML = '<p style="color: red;">âŒ ErrorHandler not initialized</p>';
                return;
            }

            const testCases = [
                { input: '', expected: false, description: 'ë¹ˆ ê°’' },
                { input: '   ', expected: false, description: 'ê³µë°±ë§Œ' },
                { input: 'ê¹€ì² ìˆ˜', expected: true, description: 'ì •ìƒ ì´ë¦„' },
                { input: 'a'.repeat(21), expected: false, description: 'ê¸¸ì´ ì´ˆê³¼ (21ì)' },
                { input: 'a'.repeat(20), expected: true, description: 'ìµœëŒ€ ê¸¸ì´ (20ì)' },
                { input: 'ê¹€ì² ìˆ˜<script>', expected: true, description: 'íŠ¹ìˆ˜ë¬¸ì í¬í•¨ (ê²½ê³ )' },
                { input: 'ì ì‹¬ë©”ë‰´', expected: true, description: 'í•œê¸€ ì •ìƒ' },
                { input: 'Pizza', expected: true, description: 'ì˜ë¬¸ ì •ìƒ' }
            ];

            let html = '<h3>ìŠ¬ë¡¯ ë‚´ìš© ê²€ì¦ í…ŒìŠ¤íŠ¸:</h3><table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #f0f0f0;"><th style="padding: 8px; border: 1px solid #ddd;">ì…ë ¥ê°’</th><th style="padding: 8px; border: 1px solid #ddd;">ì„¤ëª…</th><th style="padding: 8px; border: 1px solid #ddd;">ì˜ˆìƒ</th><th style="padding: 8px; border: 1px solid #ddd;">ê²°ê³¼</th><th style="padding: 8px; border: 1px solid #ddd;">ë©”ì‹œì§€</th></tr>';

            testCases.forEach(testCase => {
                const validation = errorHandler.validateSlotContent(testCase.input);
                const passed = validation.isValid === testCase.expected;
                const icon = passed ? 'âœ…' : 'âŒ';
                const errorMessages = validation.errors.map(e => e.message).join(', ');
                
                html += `<tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${testCase.input || '(ë¹ˆê°’)'}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${testCase.description}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${testCase.expected ? 'ìœ íš¨' : 'ë¬´íš¨'}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${icon} ${validation.isValid ? 'ìœ íš¨' : 'ë¬´íš¨'}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; font-size: 0.9em;">${errorMessages}</td>
                </tr>`;
            });

            html += '</table>';
            resultsDiv.innerHTML = html;
        }

        function testStorageErrors() {
            const resultsDiv = document.getElementById('storageResults');
            resultsDiv.style.display = 'block';
            
            if (!errorHandler || !storageManager) {
                resultsDiv.innerHTML = '<p style="color: red;">âŒ Components not initialized</p>';
                return;
            }

            let html = '<h3>ì €ì¥ì†Œ ì˜¤ë¥˜ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸:</h3>';

            // Test storage availability
            const isAvailable = storageManager.isStorageAvailable();
            html += `<p><strong>ì €ì¥ì†Œ ì‚¬ìš© ê°€ëŠ¥:</strong> ${isAvailable ? 'âœ… ì˜ˆ' : 'âŒ ì•„ë‹ˆì˜¤'}</p>`;

            // Test storage stats
            try {
                const stats = storageManager.getStorageStats();
                html += `<p><strong>ì €ì¥ í†µê³„:</strong></p>`;
                html += `<ul>`;
                html += `<li>ì €ì¥ëœ ê²Œì„ ìˆ˜: ${stats.gamesCount}ê°œ</li>`;
                html += `<li>ì‚¬ìš©ëœ ì €ì¥ ê³µê°„: ${stats.usagePercent}%</li>`;
                html += `<li>ì €ì¥ ê³µê°„ í•œê³„: ${(stats.storageLimit / 1024 / 1024).toFixed(2)}MB</li>`;
                html += `</ul>`;
            } catch (error) {
                html += `<p style="color: red;">âŒ ì €ì¥ í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}</p>`;
            }

            // Test error handling
            try {
                const fakeError = new Error('Test error');
                fakeError.name = 'QuotaExceededError';
                const errorInfo = errorHandler.handleStorageError(fakeError, 'test');
                html += `<p><strong>ì˜¤ë¥˜ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸:</strong> âœ… ${errorInfo.title}</p>`;
                html += `<p><em>${errorInfo.message}</em></p>`;
            } catch (error) {
                html += `<p style="color: red;">âŒ ì˜¤ë¥˜ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}</p>`;
            }

            resultsDiv.innerHTML = html;
        }

        function testQuotaExceeded() {
            const resultsDiv = document.getElementById('storageResults');
            resultsDiv.style.display = 'block';
            
            if (!errorHandler) {
                resultsDiv.innerHTML = '<p style="color: red;">âŒ ErrorHandler not initialized</p>';
                return;
            }

            // Simulate quota exceeded error
            const quotaError = new Error('Storage quota exceeded');
            quotaError.name = 'QuotaExceededError';
            
            const errorInfo = errorHandler.handleStorageError(quotaError, 'quota test');
            
            let html = '<h3>ì €ì¥ ê³µê°„ ë¶€ì¡± ì‹œë®¬ë ˆì´ì…˜:</h3>';
            html += `<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 1rem; border-radius: 8px;">`;
            html += `<h4>${errorInfo.title}</h4>`;
            html += `<p>${errorInfo.message}</p>`;
            if (errorInfo.suggestions) {
                html += `<p><strong>í•´ê²° ë°©ë²•:</strong></p><ul>`;
                errorInfo.suggestions.forEach(suggestion => {
                    html += `<li>${suggestion}</li>`;
                });
                html += `</ul>`;
            }
            html += `</div>`;
            
            resultsDiv.innerHTML = html;
        }

        function testCanvasFallback() {
            const container = document.getElementById('canvasFallbackContainer');
            
            if (!errorHandler) {
                container.innerHTML = '<p style="color: red;">âŒ ErrorHandler not initialized</p>';
                return;
            }

            // Create mock ladder data
            const mockLadderData = {
                verticalLines: 4,
                horizontalBars: [
                    { level: 0, bars: [0, 2] },
                    { level: 1, bars: [1] },
                    { level: 2, bars: [0, 2] }
                ]
            };

            container.innerHTML = '<h4>Canvas ëŒ€ì²´ ê¸°ëŠ¥ (SVG):</h4>';
            
            try {
                errorHandler.createCanvasFallback(container, mockLadderData);
                container.innerHTML += '<p style="color: green;">âœ… SVG ëŒ€ì²´ ê¸°ëŠ¥ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
            } catch (error) {
                container.innerHTML += `<p style="color: red;">âŒ Canvas ëŒ€ì²´ ê¸°ëŠ¥ ì‹¤íŒ¨: ${error.message}</p>`;
            }
        }

        function testErrorMessages() {
            const container = document.getElementById('errorMessageContainer');
            
            if (!errorHandler) {
                container.innerHTML = '<p style="color: red;">âŒ ErrorHandler not initialized</p>';
                return;
            }

            container.innerHTML = '<h4>ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ í…ŒìŠ¤íŠ¸:</h4>';

            // Test different types of error messages
            const errorTypes = [
                {
                    type: 'error',
                    title: 'ì‹¬ê°í•œ ì˜¤ë¥˜ í…ŒìŠ¤íŠ¸ âŒ',
                    message: 'ì´ê²ƒì€ ì‹¬ê°í•œ ì˜¤ë¥˜ ë©”ì‹œì§€ì…ë‹ˆë‹¤.',
                    suggestions: ['í•´ê²° ë°©ë²• 1', 'í•´ê²° ë°©ë²• 2'],
                    severity: 'error'
                },
                {
                    type: 'warning',
                    title: 'ê²½ê³  ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸ âš ï¸',
                    message: 'ì´ê²ƒì€ ê²½ê³  ë©”ì‹œì§€ì…ë‹ˆë‹¤.',
                    severity: 'warning'
                },
                {
                    type: 'info',
                    title: 'ì •ë³´ ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸ â„¹ï¸',
                    message: 'ì´ê²ƒì€ ì •ë³´ ë©”ì‹œì§€ì…ë‹ˆë‹¤.',
                    severity: 'info'
                }
            ];

            errorTypes.forEach((errorInfo, index) => {
                setTimeout(() => {
                    errorHandler.showErrorMessage(container, errorInfo);
                }, index * 1000);
            });
        }
    </script>
</body>
</html>